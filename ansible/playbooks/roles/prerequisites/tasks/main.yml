---
# Role: prerequisites
# Purpose: Prepare Linux nodes for Kubernetes installation

- name: Disable swap immediately
  command: swapoff -a
  tags: prerequisites

- name: Comment swap entry in /etc/fstab
  replace:
    path: /etc/fstab
    regexp: '^([^#].* swap .*)$'
    replace: '# \1'
  tags: prerequisites

- name: Enable IPv4 forwarding
  copy:
    dest: /etc/sysctl.d/k8s.conf
    content: |
      net.ipv4.ip_forward = 1
  tags: prerequisites
  notify: Apply sysctl

- name: Load br_netfilter module
  modprobe:
    name: br_netfilter
    state: present
  tags: prerequisites

- name: Persist br_netfilter module for boot
  copy:
    dest: /etc/modules-load.d/br_netfilter.conf
    content: br_netfilter
  tags: prerequisites

- name: Set sysctl for bridge traffic
  copy:
    dest: /etc/sysctl.d/99-kubernetes.conf
    content: |
      net.bridge.bridge-nf-call-iptables  = 1
      net.bridge.bridge-nf-call-ip6tables = 1
  tags: prerequisites
  notify: Apply sysctl
