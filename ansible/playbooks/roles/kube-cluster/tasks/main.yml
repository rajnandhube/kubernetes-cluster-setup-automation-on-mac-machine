---
# Role: kube-cluster
# Purpose: Initialize control-plane and join worker nodes
# Supports tags: control-plane, workers

# ===================== CONTROL-PLANE TASKS =====================
- name: "Control-plane: Load br_netfilter module"
  modprobe:
    name: br_netfilter
    state: present
  when: "'control-plane' in group_names"
  tags: control-plane

- name: "Control-plane: Persist br_netfilter on boot"
  copy:
    dest: /etc/modules-load.d/br_netfilter.conf
    content: "br_netfilter\n"
    owner: root
    group: root
    mode: '0644'
  when: "'control-plane' in group_names"
  tags: control-plane

- name: "Control-plane: Configure sysctl for Kubernetes networking"
  copy:
    dest: /etc/sysctl.d/99-kubernetes.conf
    content: |
      net.bridge.bridge-nf-call-iptables = 1
      net.bridge.bridge-nf-call-ip6tables = 1
    owner: root
    group: root
    mode: '0644'
  when: "'control-plane' in group_names"
  tags: control-plane
  notify: Apply sysctl

- name: "Control-plane: Apply sysctl settings"
  command: sysctl --system
  when: "'control-plane' in group_names"
  tags: control-plane

- name: "Control-plane: Initialize Kubernetes cluster"
  command: >
    kubeadm init
    --apiserver-advertise-address={{ ansible_host }}
    --pod-network-cidr=10.244.0.0/16
    --upload-certs
  args:
    creates: /etc/kubernetes/admin.conf
  register: kubeadm_init
  when: "'control-plane' in group_names"
  tags: control-plane

- name: "Control-plane: Create .kube directory"
  file:
    path: /home/ubuntu/.kube
    state: directory
    owner: ubuntu
    group: ubuntu
    mode: '0755'
  when: "'control-plane' in group_names"
  tags: control-plane

- name: "Control-plane: Copy kubeconfig"
  copy:
    src: /etc/kubernetes/admin.conf
    dest: /home/ubuntu/.kube/config
    owner: ubuntu
    group: ubuntu
    mode: '0644'
    remote_src: yes
  when: "'control-plane' in group_names"
  tags: control-plane

- name: "Control-plane: Deploy Flannel network"
  command: kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml
  environment:
    KUBECONFIG: /home/ubuntu/.kube/config
  when: "'control-plane' in group_names"
  tags: control-plane

- name: "Control-plane: Generate join command for workers"
  command: kubeadm token create --print-join-command
  register: kubeadm_join_cmd
  changed_when: false
  when: "'control-plane' in group_names"
  tags: control-plane

- name: "Control-plane: Set join command fact"
  set_fact:
    join_command: "{{ kubeadm_join_cmd.stdout }}"
  when: "'control-plane' in group_names"
  tags: control-plane

- name: "Control-plane: Restart services"
  systemd:
    name: "{{ item }}"
    state: restarted
  loop:
    - containerd
    - kubelet
  when: "'control-plane' in group_names"
  tags: control-plane

# ===================== WORKER NODE TASKS =====================
- name: "Workers: Join Kubernetes cluster"
  shell: "{{ hostvars['control-plane']['join_command'] }} --ignore-preflight-errors=all"
  args:
    executable: /bin/bash
  when: "'workers' in group_names"
  tags: workers

- name: "Workers: Restart containerd and kubelet"
  systemd:
    name: "{{ item }}"
    state: restarted
  loop:
    - containerd
    - kubelet
  when: "'workers' in group_names"
  tags: workers
